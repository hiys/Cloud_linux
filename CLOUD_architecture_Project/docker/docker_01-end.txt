

			             OSI参考模型(七层框架)

          [5] 应用层        |<----------协议--------->|	        应用层     (计算机) APDU [是应用层协议数据单元]【网络服务与最终用户的一个接口】
                HTTP  FTP  TFTP  SMTP【邮件协议】  SNMP【Simple Network Management Protocol 简单网络管理协议，SNMP就是为了让别人能够获得路由器上的统计数据而约定好的数据交流的规则】  DNS
                    上层数据
6  接口      
             表示层         |-----------协议-----------|         表示层              PPDU [是表示层协议数据单元]【数据的表现形式，如加密、压缩】
5  接口
 	     会话层         |-----------协议-----------|         会话层              SPDU [是会话层协议数据单元]【建立、管理、中止会话，例如断点续传】
4  接口      
      	  [4] 传输层        <----------协议--------->         传输层     (防火墙) TPDU [是传输层协议数据单元,即 segment "数据段"]【定义传输数据的协议端口号，以及流控和差错校验】
                TCP      UDP
                TCP头部     上层数据
3  接口
       	  [3] 网络层        <----------协议--------->         网络层     (路由器)  package 数据包 【用抓包工具抓到的一条条记录就是包】【进行逻辑地址寻址，实现不同网络之间的通信】
                ICMP【ping这个工具 使用的协议】  IGMP【Internet Group Manage Protocol ： Internet组管理协议，提供internet网际多点 传送的功能,即将一个ip包拷贝给多个host，是一个尚处于实验阶段的协议】    IP   ARP【地址解析协议 Address Resolution Protocol】   RARP【Reverse Address Resolution Protocol 反向地址转换协议，允许局域网的物理机 从网关服务器的 ARP 表 或者缓存上 请求转换 其 IP 地址】
                IP头部   TCP头部     上层数据
2  接口
          [2] 数据链路层    <----------协议--------->         数据链路层 (交换机)  frame  数据帧 【链路层分组 称为 帧 】【建立逻辑连接、进行硬件地址寻址、差错校验等功能】
                MAC头部  IP头部   TCP头部   上层数据
1  接口   
          [1] 物理层	    <----------协议--------->	        物理层     (网卡)    bit   比特流  【建立、维护、断开物理连接】

          层            主机A                              主机B          数据单元
-------------------------------------------------------------------------------------------------------------------------------------
1物理层【网卡】 2 数据链路层 【交换机】3 网络层 【路由器】4 传输层 【防火墙】 会话层 表示层 5 应用层 【计算机 软件平台】

ICMP【ping这个工具 使用的协议】  

IGMP【Internet Group Manage Protocol ： 9
Internet组管理协议，
提供internet网际多点 传送的功能,即将一个ip包拷贝给多个host，是一个尚处于实验阶段的协议】    

ARP【地址解析协议 Address Resolution Protocol

ARP协议就是将IP地址转换为MAC物理地址,

在 数据链路层 中传输的 数据报(Datagram) 只能识别MAC地址，

所以只能将IP地址转换为MAC物理地址再进行传输和定向；

ARP server先将目的地的IP地址转换成物理地址，
发出一个ARP request,
这个request是个没有指定目的地的广播，

当网络中有匹配的物理地址时，
就将这个物理地址返回，即ARP reply，

但ARP reply是有明确的目标地址的，是单播。
这时，数据包就有方向了，就可以继续向目的地进发了。
】 

ARP Address  Resolution  Protocol  地址转换协议，
在以太网中，所有对IP的访问最终都转化为对
网卡MAC地址的访问

[root@hiys ~]# cat  -n /etc/ethertypes  |sed  -n  '13p;28p'
    13	ARP		0806	ether-arp	#
    28	802_1Q		8100	8021q 1q 802.1q	dot1q # 802.1Q Virtual LAN tagged frame

[root@hiys ~]# arp  -n
Address                  HWtype  HWaddress           Flags Mask            Iface
176.121.213.1            ether   88:f0:77:d1:6a:cd   C                     enp2s0
 
[root@hiys ~]# cat  /proc/net/arp  ##查看arp静态绑定地址
IP address       HW type     Flags       HW address            Mask     Device
176.121.213.1    0x1         0x2         88:f0:77:d1:6a:cd     *        enp2s0

[root@hiys ~]# ifconfig  enp2s0  |head   -4
enp2s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 176.121.213.151  netmask 255.255.255.0  broadcast 176.121.213.255
        inet6 fe80::1e1b:dff:fe54:282  prefixlen 64  scopeid 0x20<link>
        ether 1c:1b:0d:54:02:82  txqueuelen 1000  (Ethernet)

[root@hiys ~]# tail   -2  /etc/resolv.conf
# Generated by NetworkManager
nameserver 176.121.0.100


 RARP【
     Reverse Address Resolution Protocol 反向地址转换协议，
允许局域网的物理机 从网关服务器的 ARP 表 或者缓存上 请求 转换 其 IP 地址,
也就是将MAC物理地址转换为IP地址

RARP协议是为了
获取无磁盘操作系统的IP地址而设计的。
具有本地磁盘的系统通常是从磁盘中的配置文件中读取IP地址的，

但是无盘系统无法这样操作，
所以就需要将MAC地址转换成IP地址了
】

无盘系统
比如有些网吧的机器本身没有硬盘，
而是通过局域网连接到服务器。
从这些机器上看到的磁盘实际上是共享的服务器的磁盘


计算机网络的功能
数据通信、资源共享、增加数据可靠性、提高系统处理能力

计算机网络的发展
60年代:分组交换
70-80年代:TCP/IP
90年后:Web技术

标准：一致同意的规则

ISO（国际标准化组织）在网络通信中创建了OSI（开放系统互联）模型。
ANSI（美国国家标准化局）
ITU-T（国际电信联盟-电信标准部）
IEEE（电气和电子工程师学会）

按照网络规模和使用范围分类为
WAN：广域网    LAN:局域网

网络设备
交换机、路由器
网络设备生产厂商：cisco思科，华为。

网络拓扑结构
1、点对点
两台设备之间有一条单独的连接，通常用于广域网连接
2、星型拓扑
1）优点：易于实现、易于网络扩展、易于故障排查
2）缺点：中心节点压力大、组网成本较高
3、网型拓扑结构
1）各个节点至少与其他两个节点相连
2）可靠性高、组网成本高

OSI
1、国际标准化组织（ISO）
开放系统互连参考模型OSI
OSI是一个开放式体系结构，它规定将网络分为七层
2、协议分层
为了降低网络设计的复杂性，将协议进行了分层设计

应用层：网络服务与最终用户的一个接口
表示层：数据的表现形式，如加密、压缩。
会话层：建立、管理、中止会话，例如断点续传。
传输层：定义传输数据的协议端口号，以及流控和差错校验。
网络层：进行逻辑地址寻址，实现不同网络之间的通信。
数据链路层：建立逻辑连接、进行硬件地址寻址、差错校验等功能。
物理层：建立、维护、断开物理连接。

TCP/IP协议族的组成
应用层：HTTP、https、FTP、TFTP、SMTP 、SNMP、DNS
传输层：TCP、UDP
网络层：ICMP、IGMP、IP、ARP

PDU（协议数据单元）
传输层    段   segment
网络层    包   packet
数据链路层 帧  frame
物理层     比特 bit

相应层次的设备
应用层     计算机
传输层     防火墙
网络层     路由器
数据链路层 交换机
物理层     网卡

接口
以太网接口：
RJ-45水晶头
光纤接口：
FC 、ST、SC 
LC 窄体方形光纤接头（目前主流）
MT-RJ 

双绞线
1）双绞线分类：
屏蔽双绞线 （STP）
线外包裹一层金属网膜，用于电磁环境非常复杂的工业环境中 
非屏蔽双绞线 （UTP）
2）双绞线标准与分类 ：
Cat5五类双绞线，适用于100Mbps的网络
Cat 5e衰减更小，适用于100Mbps的网络，串扰更少，性能优于5类线 （超五类）
Cat 6适用于1000Mbps的网络
Cat 7适用于10000Mbps的网络
4、双绞线的连接规范
1）线序
T568A：
白绿、绿、白橙、蓝、白蓝、橙、白棕、棕
T568B：
白橙、橙、白绿、蓝、白蓝、绿、白棕、棕 
2）线缆的连接：
标准网线（直连线或直通线）：用于连接不同设备（A-A，B-B）[交换机 可以直接 用 直通线 ]
交叉网线：用于连接相同设备 （A-B）
全反线 ：不用于以太网的连接，主要用于计算机的串口和路由器或交换机的console（控制口）相连
例外情况：版本较新设备可以随意使用标准与交叉网线而不受限制，设备本身具备自动识别功能。

5、物理层设备
网卡、中继器

======================
交换机的工作模式：
Switch>用户模式
Switch>enable 
Switch#特权模式
Switch#configure  terminal 
Switch(config)#全局配置模式
Switch(config)#interface fastEthernet 0/1
Switch(config-if)#接口模式
exit返回上一模式
end直接退到特权模式

命令输入错误被卡住时同时按键盘ctrl+shift+6这三个按键

常用命令：
Switch(config)#hostname S1修改主机名为S1
Switch#show  running-config查看配置信息

配置enable明文口令
全局配置模式：enable  password  123
保存交换机的配置
特权： copy  running-config  startup-config
或 write
恢复设备出厂默认值
特权：erase  startup-config
重启：reload

设备配置的准备工作
空闲一段时间后，重回初始界面的问题
switch(config)#line con 0
switch(config-line)#exec-timeout 0 0

配置输出日志同步
Switch(config)#line console 0
Switch(config-line)#logging synchronous

禁用DNS查询
switch(config)#no ip domain-lookup


--------------------============================
数据传输速率的单位是bit/s 记作：bps

1m/s指的是是1024KB/s

[root@hiys ~]# echo  "scale=2;1000/8" |bc
125.00
8bit=1Byte
1Kb=1000bit=125Byte

[root@hiys ~]# echo  "scale=2;1000*1000/8" |bc
125000.00
[root@hiys ~]# echo  "scale=2;1000*1000/8/1024" |bc
122.07

1Mb=1000 000 bit= 125 000 Byte= 122.07 KByte

[root@hiys ~]# echo  "scale=2;100*1000*1000/8/1024" |bc
12207.03
[root@hiys ~]# echo  "scale=2;100*1000*1000/8/1024/1024" |bc
11.92
100Mb= 12207.03KByte = 11.92 MByte

Mbps 即 Milionbit pro second(百万位每秒)；
Kbps 即 Kilobit pro second（千位每秒）；
 bps 即 bit pro second（位每秒）；

速度单位，bit即比特，通常用b（小写）表示，指一位二进制位，Milionbit = 1000Kilobit = 1000 000 bit；

所以1Mbps=1000 000bps；

这是通常用来衡量带宽的单位，指每秒钟传输的二进制位数；

而通常软件上显示的速度则是指每秒种传输的字节数（Byte）通常用B（大写）表示；
MB即百万字节也称兆字节；
KB即千字节；
B即字节；
之间关系为1MB=1024KB=1024*1024B；
1B=8b；

数据传输速率的单位是bit/s 记作：bps

1m/s指的是是1024KB/s

[root@hiys ~]# echo  "scale=2;1000/8" |bc
125.00
8bit=1Byte
1Kb=1000bit=125Byte

[root@hiys ~]# echo  "scale=2;1000*1000/8" |bc
125000.00
[root@hiys ~]# echo  "scale=2;1000*1000/8/1024" |bc
122.07

1Mb=1000 000 bit= 125 000 Byte= 122.07 KByte

[root@hiys ~]# echo  "scale=2;100*1000*1000/8/1024" |bc
12207.03
[root@hiys ~]# echo  "scale=2;100*1000*1000/8/1024/1024" |bc
11.92
100Mb= 12207.03KByte = 11.92 MByte

[root@hiys ~]# echo  "scale=2;1000*1000*1000/8/1024/1024" |bc
119.20
1000Mb=  119.20 MB

======================================
DNS占用53号端口，同时使用TCP和UDP协议。

那么DNS在什么情况下使用这两种协议？
DNS在区域传输的时候使用TCP协议，
其他时候使用UDP协议。

DNS区域传输的时候使用TCP协议：

1.辅域名服务器会定时（一般3小时）
向主域名服务器进行查询以便了解数据是否有变动。
如有变动，会执行一次区域传送，进行数据同步。
区域传送使用TCP而不是UDP，
因为数据同步传送的数据量比一个请求应答的数据量要多得多。

2.TCP是一种可靠连接，保证了数据的准确性。

域名解析时使用UDP协议：

客户端向DNS服务器查询域名，一般返回的内容都不超过512字节，用UDP传输即可。
不用经过三次握手，
这样DNS服务器负载更低，响应更快。
理论上说，客户端也可以指定向DNS服务器查询时用TCP，
但事实上，很多DNS服务器进行配置的时候，仅支持UDP查询包
--------------------------------------------------------------------------------------

TCP保证数据正确性，UDP可能丢包，TCP保证数据顺序，UDP不保证。

tcp协议和udp协议的差别 
TCP UDP 
是否连接 面向连接 面向非连接 
传输可靠性 可靠 不可靠 
应用场合 传输大量数据 少量数据 
速度 慢 快

TCP与UDP区别总结：

1.基于连接与无连接；
2.对系统资源的要求（TCP较多，UDP少）；
3.UDP程序结构较简单；
4.流模式与数据报模式 ；

1、TCP面向连接（如打电话要先拨号建立连接）;UDP是无连接的，即发送数据之前不需要建立连接

2、TCP提供可靠的服务。也就是说，通过TCP连接传送的数据，无差错，不丢失，不重复，且按序到达;UDP尽最大努力交付，即不保证可靠交付

3、TCP面向字节流，实际上是TCP把数据看成一连串无结构的字节流;
UDP是面向报文的 
UDP没有拥塞控制，因此网络出现拥塞不会使源主机的发送速率降低（对实时应用很有用，如IP电话，实时视频会议等）

4、每一条TCP连接只能是点到点的;UDP支持一对一，一对多，多对一和多对多的交互通信

5、TCP首部开销20字节;UDP的首部开销小，只有8个字节
6、TCP的逻辑通信信道是全双工的可靠信道，UDP则是不可靠信道
















 [4] 传输层     (防火墙) TPDU [是传输层协议数据单元,即 segment "数据段"]
 报文段， segment， 组成报文的每个分组。
 我们将 传输层分组 称为 报文段。
传输层实现报文交付。

分组(packet)
分组是在网络中传输的二进制格式的单元，
为了提供通信性能和可靠性，每个用户发送的数据会被分成多个更小的部分。
在每个部分的前面加上一些必要的控制信息组成的首部，
有时也会加上尾部，就构成了一个分组。

 [5] 应用层        |<----------协议--------->|    (计算机) APDU [是应用层协议数据单元]
数据报，Datagram，
通过网络传输的数据的基本单元，
包含一个报头（header）和数据本身，
其中报头描述了数据的目的地以及和其它数据之间的关系。
可以理解为传输数据的分组。
我们将通过网络传输的数据的基本单元称为数据报。

报文，message，
一般指完整的信息，
传输层实现报文交付。
我们将位于应用层的信息分组称为报文。
报文(message)
报文是网络中交换与传输的数据单元，
也是网络传输的单元。
报文包含了将要发送的完整的数据信息，
其长短不需一致。
报文在传输过程中会不断地封装成分组、包、帧来传输，
封装的方式就是添加一些控制信息组成的首部，
那些就是报文头。


3.数据包(data packet)
数据包是TCP/IP协议通信传输中的数据单元，
也称为“包”。
是指自包含的，带有足够寻址信息，可独立地从源主机传输到目的主机，
而不需要依赖早期的源主机和目的主机之间交换信息以及传输网络的数据包。
 
4.数据报(datagram)
面向无连接的数据传输，
其工作过程类似于报文交换。
采用数据报方式传输时，
被传输的分组称为数据报。
 
5.帧(frame)
帧是数据链路层的传输单元。
它将上层传入的数据添加一个头部和尾部，组成了帧。


由此可见，抓包抓到的是传输层的包，
所以packet，frame，Datagram，segment是存在于同条记录中的，

而frame，Datagram，segment是
基于所在协议层不同而取了不同的名字。
-----------------------------------------------------------------------------------------------------------------------------------------------

A (126) 1  -126.0.0.0  [0000  0001] -[0111 1111]  私有地址A 10.0.0.1    ~ 10.255.255.254
B (64 ) 128-191.0.0.0  [1000  0000] -[1011 1111]  私有地址B 172.16.0.1  ~ 172.31.255.254
C (32 ) 192-223.0.0.0  [1100  0000] -[1101 1111]  私有地址C 192.168.0.1 ~ 192.168.255.254
D (16 ) 224-239.0.0.0  [1110  0000] -[1110 1111]  组播地址
E (15 ) 240-254.0.0.0  [1111  0000] -[1111 1110]
        1 	 1 	 1 	 1 	 1 	 1 	 1 	 1 
	0	0	0	0	0	0	0	0
 	128	64	32	16	8	4	2	1

----------------------------------------------------------


国外 ：亚马逊AWS  微软 Azure,	IBM  SCE+,
国内：华为云 ，阿里云，百度云,腾讯云 .....

---------------------------------

阿里云应用架构
  基础架构  ------  弹性架构
              |
 大数据架构 ------应用开发架构

-----------------------------------------

阿里基础应用架构

SLB 负载均衡
       |  SLB负载均衡，流量入口
         |
        \/
  ECS 应用服务器 ------ ECS 运行应用，如CentOS6.3 服务器
         |
――――――――――
  |                  |
OSS对象存储    RDS 数据库    文件数据库【MYSQL6.5】

-----------------------------------------

阿里云 弹性 应用架构
   SLB 负载均衡
ECS   ECS   ECS  ECS  | ECS 自动伸缩
----------------------------------------|
    |                |
OSS对象存储   RDS 数据库   

-----------------------------
弹性云服务器 ECS  （ Elastic  Compute  Service ）
----------------------------------------------
      	  [4] 传输层        <----------协议--------->         传输层     (防火墙) TPDU [是传输层协议数据单元,即 segment "数据段"]
                TCP      UDP
                TCP头部     上层数据
3  接口
       	  [3] 网络层        <----------协议--------->         网络层     (路由器)  package 数据包
                ICMP  IGMP    IP   ARP   RARP
                IP头部   TCP头部     上层数据
2  接口
          [2] 数据链路层    <----------协议--------->         数据链路层 (交换机)  frame  数据帧
                MAC头部  IP头部   TCP头部   上层数据
--------------------------------------------------------------------------------
Virtual Server via Network Address Translation 
通过网络地址转换实现虚拟服务器

一、lvs介绍
Linux Virtual Server项目的目标 ：
使用集群技术和Linux操作系统实现一个高性能、高可用的服务器，
它具有很好的可伸缩性（Scalability）、
可靠性（Reliability）
和可管理性（Manageability）

LVS的英文全名为“Linux Virtual Server”，即Linux虚拟服务器，
是一个虚拟的四层交换器集群系统，
根据目标地址和目标端口实现用户请求转发，
本身不产生流量，
只做用户请求转发，
目前是负载均衡性能最好的集群系统。

二、lvs集群的类型：
lvs-nat：修改请求报文的目标IP,多目标IP的DNAT
lvs-dr：操纵封装新的MAC地址
lvs-tun：在原请求IP报文之外新加一个IP首部
lvs-fullnat：修改请求报文的源和目标IP

三、常用的名词
VS：Virtual Server，虚拟服务器，也称为Director
RS：Real Server(lvs)，真正的服务器，集群中各节点

OS ：【操作系统 Operating System 】

CIP：客户端IP,用户的IP

VIP：Director 虚拟服务器 向 外部 提供服务的IP
VIP: LVS虚拟的IP，用于用户访问

RIP：集群节点 真正的服务器 的 IP
RIP: Real Server 的IP

DIP：Director 虚拟服务器 与 RS真正的服务器 通信的IP
DIP: LVS Director调度器自已的IP

LIP: LVS Director调度器指定的local address 【内网ip地址】，FULLNAT模式下专用的

LB  ：负载调度器（Load Balancer）

 

名称	缩 写	说明
虚拟IP地址（Virtual Ip Address）       VIP  
VIP为Director用于向客户端计算机提供服务的IP地址。比如：www.rsq.com域名就要解析到VIP上提供服务。

真实IP地址（Real Server Ip Address）   RIP	
在集群下面节点上使用的IP地址，物理IP地址。

Director的IP地址（Director Ip Address）   DIP 
Director用于连接内网络的IP地址，物理网卡上的IP地址。是负载均衡器上的IP

客户端主机IP地址（Client Ip Address)    CIP  
客户端用户计算机请求集群服务器的IP地址，该地址用作 发送给 集群的 请求的 源IP地址。

真实服务器（Real Server)  RS 
集群节点，为LVS内部的真实服务器。



LVS主要组成部分

1）负载调度器

英文名称叫"load balancer"
或者"Director"，
它是整个集群对外的前端机，
负责将客户的请求发送到一组服务器上执行
，而客户认为服务是来自一个IP地址
(我们可称之为虚拟IP地址VIP)上的。

2）服务器池

"server pool/ Realserver"，
是一组真正执行客户请求的服务器，
执行的服务一般有WEB、MAIL、FTP和DNS等。

3）共享存储

"shared storage"，
它为服务器池提供一个共享的存储区，
这样很容易使得服务器池拥有相同的内容，提供相同的服务。

LVS 的四种工作模式原理简介及优缺点

1、NAT模式

原理 
这个是 通 过  网 络 地 址 转 换  的方法来实现调度的。
首先 调度器 (LB)  接收到客户的请求数据包时（请求的目的IP为VIP），
根据调度算法 决定 将 请求 发送给 哪个后端的 真实服务器（RS）。
然后 调度 就把客户端 发送的请求数据包 的目标IP地址 及 端口 改成 后端真实服务器 的IP地址（RIP）,
这样 真实服务器（RS） 就能够接收到 客户的请求数据包了。 
真实服务器响应完请求后，
查看默认路由（NAT模式下我们需要把RS的默认路由设置为LB服务器 【DIP地址】。）
把响应后的数据包发送给LB,
LB再接收到响应包后，
把包的源地址改成虚拟地址（VIP）然后发送回给客户端。

1、LVS-NAT
原理简述
客户端向VIP发起请求连接，Director在经过调度之后选取RS，将本地端口与RS的端口做映射，
然后RS返还数据Director将数据返还客户端
-----------------------------------------------------

原理图简述：

1)客户端请求数据，目标IP为VIP

2)请求数据到达LB服务器，LB根据调度算法 将 目的地址 
修改为 RIP地址
及对应端口
（此RIP地址是根据调度算法得出的）
并在连接HASH表中记录下这个连接。

3)数据包从LB服务器到达RS服务器webserver，然后webserver进行响应。
Webserver的网关必须是 调度器 LB 【即VS：Virtual Server，虚拟服务器，也称为Director 的DIP地址】，
然后将数据返回给 调度器 LB服务器。

4)收到 真实服务器（RS） 的返回后的数据，
根据 连接HASH表 修改 源地址VIP&目标地址CIP，及对应端口80.
然后数据就从LB出发到达客户端。

5)客户端收到的就只能看到VIP信息。

NAT模式优缺点：

1、NAT技术将请求的报文和响应的报文都需要通过LB进行地址改写，
因此网站访问量比较大的时候
LB负载均衡调度器有比较大的瓶颈，
一般要求  最多  只能   10-20台 节点

2、只需要在LB上配置一个公网IP地址【即VIP地址】就可以了。

3、每台内部的节点服务器的网关地址
必须是
调度器LB的内网地址【DIP地址】。

4、NAT模式支持对IP地址和端口进行转换。
即用户请求的端口和真实服务器的端口可以不一致。
--------------------------------------------------------------------

2、TUN模式（隧道模式）【需要加密】

原理 
virtual server via ip tunneling模式:
采用NAT模式时，由于请求和响应的报文必须 通过 调度器 地址 重写，

当客户请求越来越多时，调度器处理能力将成为瓶颈。

为了解决这个问题，调度器把请求的 报文 通过 IP隧道 转发到真实的服务器。
真实的服务器 将 响应 处理后的数据 直接返回给客户端。
这样调度器就 只处理 请求 入站 报文，
由于一般网络服务应答数据比请求报文大很多，
采用VS/TUN模式后，集群系统的最大吞吐量可以提高10倍 【100-200台 节点】。

VS/TUN的工作流程图如下所示，
它和NAT模式不同的是，
它在 LB 和 RS 之间的传输 不用改写 IP地址。

而是把客户请求包封装在一个 IP tunnel里面，

然后发送给RS节点服务器，

节点服务器接收到之后解开IP tunnel后，
进行响应处理。
并且  直接 把 包 通过 自己的外网地址 发送给客户 不用经过LB服务器。 


Tunnel原理流程图: 
1）客户请求数据包，目标地址VIP发送到LB上。

2）LB接收到客户请求包，进行IP Tunnel封装。
即在原有的包头加上IP Tunnel的包头。
然后发送出去。

3）RS节点服务器根据IP Tunnel包头信息
（此时就有一种逻辑上的隐形隧道，只有LB和RS之间懂）
收到请求包，
然后解开IP Tunnel包头信息，
得到客户的请求包并进行响应处理。

4）响应处理完毕之后，RS服务器使用自己的出公网的线路，
将这个响应数据包发送给客户端。源IP地址还是VIP地址。

原理简述
客户端向VIP发送请求时，[源CIP；目的VIP]，
Director经过 调度 轮询 后 选择 一个RS 后 
使用 隧道技术 再次封装后 
向RS发送【源DIP；目的RIP [源CIP；目的VIP]】，
RS通过隧道收到请求后 拆开数据后 得到[源CIP；目的VIP]，
发现 目的IP 为 自己L0接口的IP 后 就把数据收下，
找到数据后 
将数据直接通过 公网 返还给客户端[源VIP；目的CIP]

特性
1.RIP、DIP、VIP必须为公网IP
2.RS网关不指向Director
3.请求报文由Director转发至RS，回复报文由RS直接发送至客户端
4.不支持端口映射
5.RS的OS【操作系统 Operating System 】 必须支持隧道技术
6.Director与RS、RS与RS可以跨网段、跨机房。

----------------------------------------------
      	  [4] 传输层        <----------协议--------->         传输层     (防火墙) TPDU [是传输层协议数据单元,即 segment "数据段"]
                TCP      UDP
                TCP头部     上层数据
3  接口
       	  [3] 网络层        <----------协议--------->         网络层     (路由器)  package 数据包
                ICMP  IGMP    IP   ARP   RARP
                IP头部   TCP头部     上层数据
2  接口
          [2] 数据链路层    <----------协议--------->         数据链路层 (交换机)  frame  数据帧
                MAC头部  IP头部   TCP头部   上层数据
--------------------------------------------------------------------------------

3、DR模式（直接路由模式）【性能最高,ip必须公网，费钱】

原理 
DR模式是通过 改写 请求报文的 目标MAC地址，
将请求发给真实服务器的，
而真实服务器 响应后的处理结果 直接 返回给 客户端用户。
同TUN模式一样，
DR模式可以极大的提高集群系统的伸缩性。
而且DR模式 没有IP隧道 的开销，
对集群中的真实服务器 也没有  必须支持IP隧道协议 的要求。
但是要求 调度器LB 与 真实服务器RS 都有 一块网卡 连接到 同一物理网段上，必须在 同一个局域网 环境。

DR模式是互联网使用比较多的一种模式。

---------------------------------------------
三、常用的名词
VS：Virtual Server，虚拟服务器，也称为Director
RS：Real Server(lvs)，真正的服务器，集群中各节点

OS ：【操作系统 Operating System 】

CIP：客户端IP,用户的IP

VIP：Director 虚拟服务器 向 外部 提供服务的IP
VIP: LVS虚拟的IP，用于用户访问

RIP：集群节点 真正的服务器 的 IP
RIP: Real Server 的IP

DIP：Director 虚拟服务器 与 RS真正的服务器 通信的IP
DIP: LVS Director调度器自已的IP

LIP: LVS Director调度器指定的local address 【内网ip地址】，FULLNAT模式下专用的

LB  ：负载调度器（Load Balancer）


LVS-FULLNAT转发模式

在大规模的网络下，在淘宝的业务中，官方LVS满足不了需求；原因有3点， 
1) 刚才讲三种转发模式，部署成本比较高； 
2) 和商用的负载均衡比，LVS没有DDOS防御攻击功能； 
3) 主备部署模式，性能无法扩展；一个VIP下的流量特别大怎么办？

FULLNAT原理： 
FULLNAT转发数据包是类似NAT模式，

IN和OUT数据包都是经过LVS；
唯一的区别：后端RealServer 或者交换机不需要做任何配置。 

FULLNAT是一种新的转发模式
C 主要思想：引入local address（内网ip地址），
cip-vip转
换为lip->rip，
而 lip和rip均为IDC内网ip，可以跨vlan通讯；
FULLNAT：NAT模型的改进版

特性：

实现RS间跨VLAN通信，是NAT模式的改进版；

默认内核不支持，需重新编译内核 【 最难点 】，才能使用；

适用场景：

内网服务器跨VLAN的负载分担


FULLNAT工作流程
    1、引入LIP(local address)，可以配置多个，也可以使用DIP
    2、客户端请求VIP 
      CIP-VIP --> LIP-RIP
   3、Director接受到请求,根据调度算法得出转发的RS, 将CIP修改为LIP, VIP修改为对应RIP, 转发给RS 
      LIP-RIP -->  CIP - VIP
   4、RS接受到请求后, 响应请求给LIP, Director将响应报文RIP改为VIP, LIP改为CIP, 响应给用户
    
实现FULLNAT模型需要注意的:
    1、请求报文和响应报都要通过Director
    【 LIP-RIP 】
   2、RIP接收到的请求报文的源地址为LIP,目标地址为RIP
    3、支持端口映射
    4、为了保证应用透明性，通过tcp option传递client ip给RealServer(TOA).
       要RS读取数据包中的tcp option来记录client ip
    5、和NAT比，正常转发性能下降<10%



			             OSI参考模型(七层框架)

          [5] 应用层        |<----------协议--------->|	        应用层     (计算机) APDU [是应用层协议数据单元]
                HTTP  FTP  TFTP  SMTP  SNMP  DNS
                    上层数据
6  接口      
             表示层         |-----------协议-----------|         表示层              PPDU [是表示层协议数据单元]
5  接口
 	     会话层         |-----------协议-----------|         会话层              SPDU [是会话层协议数据单元]
4  接口      
      	  [4] 传输层        <----------协议--------->         传输层     (防火墙) TPDU [是传输层协议数据单元,即 segment "数据段"]
                TCP      UDP
                TCP头部     上层数据
3  接口
       	  [3] 网络层        <----------协议--------->         网络层     (路由器)  package 数据包
                ICMP  IGMP    IP   ARP   RARP
                IP头部   TCP头部     上层数据
2  接口
          [2] 数据链路层    <----------协议--------->         数据链路层 (交换机)  frame  数据帧
                MAC头部  IP头部   TCP头部   上层数据
1  接口   
          [1] 物理层	    <----------协议--------->	        物理层     (网卡)    bit   比特流

          层            主机A                              主机B          数据单元
-----------------------------------------------------------------------------------------------------------------------------------------------









1 docker01
docker 安装

停止禁用防火墙
systemctl stop firewalld
systemctl mask firewalld

禁用 selinux

配置 yum 源，安装 docker
yum install docker-engine

启动测试
systemctl start docker
ifconfig  启动后可以看见 docker0 
docker version

搜索 docker  search
下载 docker  pull  busybox
查看帮助  docker  help  pull
查看镜像  docker  images

导入镜像
[root@localhost ~]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
[root@localhost ~]# docker load <busybox.tar 
c5183829c43c: Loading layer  1.36 MB/1.36 MB
Loaded image: busybox:latest32.77 kB/1.36 MB
[root@localhost ~]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
busybox             latest              f6e427c148a7        3 weeks ago         1.146 MB

导出镜像
docker save busybox >busybox.tar

导入所有文件
unzip docker_img.zip
cd   docker_images
for i in *;do docker load <${i};done

利用镜像启动容器
docker run -it busybox /bin/sh
docker run -it centos /bin/bash

查看容器列表
docker  ps

查看详细信息
docker inspect  21d2aeb977cc
docker inspect -f '{.NetworkSettings.IPAddress}' 21d2aeb977cc

docker 问题列表，及解答
问题：docker run -it  busybox  /bin/bash  报错问题
原因：
最后的命令是容器内部命令，容器内，存在才可以执行
可以不指定，不指定启动默认命令

问题：docker run -it  centos  退出后，配置全部丢失
原因：
run 启动的是新的容器，老的容器退出后就停止了
启动管理一个老的容器可以使用 docker start|stop|restart

问题：老容器启动以后，怎么在进入？
docker  exec -it  容器id  /bin/bash
docker  attach    容器id

exec 与 attach 的区别
exec     单独启动命令运行，与容器启动的终端无关
attach  不启动新的命令，直接连接 console 终端
exec     退出不会影响容器的运行
attach  退出后，容器结束

问题：如果我使用attach 连接容器后，怎么才能不结束容器？
解决方法：把容器放后台，使用快捷键 ctrl + pq

问题：attach 为什么退出后，容器会结束？
因为 attach 连接进容器的 pid 1 的进程，当 attach 结束时候，pid 为 1 的进程被结束
所有整个容器被销毁

问题：docker run -it  nginx  没响应？
因为 nginx 启动的默认 cmd 时 nginx daemon，该进程不是一个交互式的进程

docker run 使用
-i   交互式的
-t   分配终端
-d  把容器放在后台运行

docker  run  -it    centos   cmd   启动一个交互式的容器，在前台运行
docker  run  -d    centos   cmd   启动一个非交互式的容器，在后台运行
docker  run  -itd  centos   cmd   启动一个交互式的容器，在后台运行

测试
docker  run  -it    centos  /bin/bash           成功
docker  run  -d    centos  /bin/bash           失败
docker  run  -itd  centos  /bin/bash           成功

docker  run -it     nginx   nginx                   失败
docker  run -d     nginx   nginx                   失败
docker  run -itd   nginx   nginx                   失败

docker  run -it      nginx   nginx -g "daemon off;"   成功
docker  run -d      nginx   nginx -g "daemon off;"   成功
docker  run -itd    nginx   nginx -g "daemon off;"   成功

交互式的进程启动要使用  it ， 非交互式的使用 d ，交互式的放后台使用  itd
启动  bash  的正确姿势  docker run -itd  centos
启动 nginx 的正确姿势  docker run  -d  -p 80:80  nginx

小练习： 启动一个 nginx 的容器，修改默认首页为 "hello world"

设置IP伪装访问网络
[root@room9pc19 docker]# ifconfig 
enp2s0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.40.50.119  netmask 255.255.255.0  broadcast 172.40.50.255
        ether 94:de:80:81:e3:53  txqueuelen 1000  (Ethernet)
        RX packets 5947707  bytes 593709850 (566.2 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 12611909  bytes 18788418441 (17.4 GiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

物理机上查找上网用的网卡
打开路由转发
sysctl -w net.ipv4.ip_forward=1
设置伪装上网
[root@room9pc19 docker]# iptables -t nat -I POSTROUTING -s 192.168.4.0/24 -o enp2s0 -j MASQUERADE

在虚拟机里面设置默认路由
ip route replace default via 192.168.4.254

模拟 docker 端口绑定转发
iptables -t nat -I PREROUTING -d 192.168.4.10 -p tcp --dport 8080 -i eth0 -j DNAT --to 172.17.0.3:80
docker  run -d -p 8080:80 nginx









